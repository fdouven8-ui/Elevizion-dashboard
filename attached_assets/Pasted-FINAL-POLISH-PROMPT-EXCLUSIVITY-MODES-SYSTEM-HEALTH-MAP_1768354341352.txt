FINAL POLISH PROMPT — EXCLUSIVITY MODES + SYSTEM HEALTH MAPPING CHECKS + SAFE BULK PUBLISH + /START NORMALIZATION

CONTEXT
Self-serve /start is live (KvK/BTW/branche/regio verplicht) + competitor exclusion werkt in placement engine.
E2E test is geslaagd. Nu willen we de “laatste 5%” perfect maken zodat het schaalbaar en foutloos blijft:
1) Concurrentie regels bestuurbaar per locatie (STRICT/RELAXED)
2) System Health uitbreiden met mapping checks (regio/categorie/playlist) zodat we nooit “geen targets” krijgen door ontbrekende data
3) Bulk publish veilig (simulate-all → publish-only-ok, duidelijke resultaten)
4) /start input normalisatie en harde server-side checks verbeteren

DOEL
Implementeer deze polish zonder redesign en zonder grote refactor.

BELANGRIJK
- Alles blijft status-driven en idempotent.
- Placement Engine blijft HARD blokkeren waar nodig.
- Geen breaking changes voor bestaande records: voeg defaults/migrations toe.

────────────────────────
A) EXCLUSIVITY MODES PER LOCATIE (CONCURRENTIE)
────────────────────────
1) Voeg veld toe op ScreenLocation:
- exclusivityMode: "STRICT" | "RELAXED"
Default: "STRICT"

2) Definieer regels:
STRICT:
- max 1 LIVE advert per competitorGroup per locatie (huidige gedrag)
RELAXED:
- max 2 LIVE advertenties per competitorGroup per locatie
  (of als je liever: alleen blocken bij exact dezelfde companyName; kies RELAXED=2 is eenvoudiger)

3) Update PlacementEngine.simulate():
- Bij competitor conflict check:
  - countExisting = aantal LIVE placements op locatie met dezelfde competitorGroup
  - if mode STRICT and countExisting >= 1 => reject COMPETITOR_CONFLICT
  - if mode RELAXED and countExisting >= 2 => reject COMPETITOR_CONFLICT
- Simulation report moet tonen:
  - mode + existing count + threshold

4) Update Publish transaction gate:
- Re-check conflict within DB transaction/lock:
  - zelfde logic als simulate met exclusivityMode
- Als conflict -> fail + rollback (zoals nu)

5) Admin UI:
- In ScreenLocation detail page:
  - dropdown exclusivityMode (STRICT/RELAXED)
  - helper text:
    STRICT = “max 1 concurrent per groep op deze locatie”
    RELAXED = “max 2 concurrenten per groep op deze locatie”
- In Publish Queue simulation modal:
  - toon exclusivityMode van target locaties

────────────────────────
B) SYSTEM HEALTH: MAPPING EN DATA COMPLETENESS CHECKS
────────────────────────
Voeg een nieuwe check group: “Plaatsingsdata Compleetheid”
Deze checks voorkomen silent failures:

1) Locations missing province/regionCode:
- COUNT where regionCode is null/empty
- If >0: WARNING (toon lijst met locaties + link)

2) Locations missing categoriesAllowed/audienceCategory:
- COUNT null/empty
- If >0: WARNING

3) Locations missing yodeckPlaylistId:
- COUNT null/empty
- If >0: FAIL (want publish kan niet) of WARNING (als je het niet hard wil)
Aanrader: FAIL voor locaties die isOnline=true

4) Locations stale sync:
- COUNT where isOnline=true AND lastSyncAt older than 15 minutes
- WARNING + knop “Run Sync”

5) Capacity config missing:
- COUNT where adSlotCapacitySecondsPerLoop (of maxAdsCount) null
- WARNING (want simulate kan niet betrouwbaar)

6) Advertisers missing required placement data (from /start):
- COUNT ACTIVE advertisers where businessCategory missing OR targetRegionCodes empty OR competitorGroup missing
- WARNING

Output:
- Toon aantallen + “View list” per item (klik naar filtered listing)

────────────────────────
C) SAFE BULK PUBLISH (SIMULATE-ALL → PUBLISH-ONLY-OK)
────────────────────────
Doel: ik wil meerdere goedgekeurde opdrachten in 1 keer kunnen publiceren, zonder chaos.

1) Voeg bulk action toe op /publish-queue:
- “Bulk: Simuleer & Publiceer”
Scope:
- alleen plannen met status PROPOSED of APPROVED
- alleen assets VALID

2) Bulk flow:
Step 1: Simulate all geselecteerde plannen:
- run simulate
- split into:
  - OK -> canPublish list
  - FAIL -> blocked list met reasons
Step 2: Confirm modal:
- “X worden gepubliceerd, Y geblokkeerd”
- Toon top reasons (NO_CAPACITY, COMPETITOR_CONFLICT, STALE_SYNC)
Buttons:
- “Publiceer alleen OK” (default)
- “Annuleren”
(NO “force publish”)

3) Publish stage:
- publish plans sequentially (veiliger) of met concurrency=2 max
- per plan: respect existing idempotency/outbox

4) Results report:
- Na bulk: toon tabel:
  - company, linkKey, status (PUBLISHED/FAILED/SKIPPED), reason
- Log bulkRunId in DB voor auditing

────────────────────────
D) /START NORMALIZATION + HARD SERVER VALIDATION
────────────────────────
1) Normalisatie op server (/api/start):
- companyName: trim, collapse multiple spaces
- contactName: trim
- email: lowercase + trim
- phone: trim
- kvkNumber: digits only
- vatNumber: uppercase, remove spaces
- postalCode: uppercase, remove spaces

2) Hard validation server-side (niet alleen client):
- kvkNumber: exactly 8 digits
- vatNumber: regex ^NL[0-9]{9}B[0-9]{2}$
- postalCode: regex ^[0-9]{4}[A-Z]{2}$
- businessCategory required
- targetRegionCodes must have length >=1 and must exist in regions.ts

3) Error handling:
- return structured NL errors per field
- UI toont fouten bij juiste step

4) Dedupe improvement:
- primary key: kvkNumber
- if kvk matches existing advertiser -> update that record always
- else fallback: email+companyName
- prevent duplicates in Moneybird:
  - store moneybirdContactId on advertiser
  - only create new if not exists

────────────────────────
E) OUTPUT / ACCEPTANCE TESTS
────────────────────────
Na implementatie wil ik:
1) ScreenLocation exclusivityMode is editable + werkt in simulate & publish
2) System Health toont mapping warnings met “view list” links
3) Bulk publish:
   - simuleert eerst
   - publiceert alleen OK
   - geeft netjes rapport
4) /start:
   - normaliseert inputs
   - blokkeert invalid server-side met NL field errors

Testcases:
- STRICT locatie met 1 barber live -> tweede barber rejected
- RELAXED locatie met 1 barber live -> tweede barber allowed, derde rejected
- Missing yodeckPlaylistId op online locatie -> system health FAIL
- Bulk publish met 5 plannen: 3 OK, 2 FAIL -> publiceert 3, report toont 2 met reasons
- /start vatNumber met spaties/lowercase -> genormaliseerd en accepted; fout format -> server error

IMPLEMENT NOW — NO QUESTIONS, NO REDESIGN, NO SHORTCUTS.

**Replit prompt – Fix 1) video preview speelt niet (zwart/0:00) + Fix 2) 0 matches door ontbrekende Yodeck playlist/mapping (auto-provisioning)**

Ik heb nu 2 problemen in de Video Review preview modal:

1. Video preview speelt niet af (zwart scherm, 0:00), terwijl metadata (duur/resolutie/codec) wel klopt.
2. Proposal preview geeft “0 van 1 schermen” en waarschuwing “Schermen zonder Yodeck-koppeling of playlist” (target regio: sittard). Het scherm is wel gekoppeld, maar er is nog geen geldige advertentie-playlist/mapping.

Ik wil dat dit structureel wordt opgelost, zonder grote refactor.

---

## A) Video preview fix (HTML5 streaming met Range support)

### A1) Backend: maak/controleer stream endpoint

Zorg dat er een endpoint bestaat en gebruikt wordt:

* `GET /api/assets/:assetId/stream`

Implementatie-eisen:

* Haal asset op uit DB (storageKey / object path)
* Stream vanuit object storage naar response
* Ondersteun **HTTP Range requests**:

  * Als `Range` header aanwezig: return `206 Partial Content`
  * Parse bytes `start-end` correct
  * Zet headers:

    * `Content-Type: video/mp4`
    * `Accept-Ranges: bytes`
    * `Content-Length`
    * `Content-Range`
  * Stream alleen het gevraagde range-deel
* Als geen `Range`: return `200` en stream volledig met `Content-Type: video/mp4`
* Voeg logging toe (alleen debug): `[AssetStream] range=<...> status=<200/206> assetId=<...> bytes=<...>`

### A2) Frontend: gebruik ALTIJD de stream endpoint als src

In de Video Review modal (en advertiser/asset preview waar relevant):

* Zet video src op: `/api/assets/${assetId}/stream`
* Geen directe signed URLs in de browser.
* Zet `preload="metadata"` zodat de browser direct kan starten.

**Acceptatie:** video speelt af, scrubben werkt, geen 0:00 zwart vlak.

---

## B) Proposal “0 matches” fix: auto-playlist provisioning + mapping

### B1) Definieer “sellable” playlist

Maak helper `isSellablePlaylist(playlist)`:

* playlist is geschikt als type/category `ad` of `mixed`
* en hij is gekoppeld aan een screen/location (via mapping)
* en niet gemarkeerd als “non_ad”

### B2) Auto-provisioning bij ontbreken playlist/mapping

Als proposal preview draait (`GET /api/admin/assets/:assetId/proposal`) en er zijn 0 matches met reden “geen playlist/mapping”:

1. Zoek Yodeck player/screen voor de relevante locatie(s) in target regio (readyForAds=true)
2. Check of er al een playlistId/mapping bestaat in DB voor dit screen
3. Als niet:

   * Maak via Yodeck API een playlist aan (of vind bestaande “auto-playlist” op naam)
   * Naam: `${locationName}(auto-playlist-${yodeckPlayerId}-fit)`
   * Type: `mixed` (of `ad`)
   * Koppel deze playlist aan de player/screen (volgens jullie huidige Yodeck mapping aanpak)
   * Sla mapping op in DB: `screenId -> yodeckPlaylistId` + `playlistType='ad'` + `isAutoGenerated=true`
   * Log audit event: `PLAYLIST_AUTO_CREATED` met playlistId, screenId, locationId
4. Run proposal nogmaals nadat provisioning gelukt is.

### B3) UI/Copy: juiste melding

* Als auto-provisioning lukt: proposal moet matches tonen (geen waarschuwing meer).
* Als provisioning faalt: toon next step met echte reden (bijv. “Yodeck API error”, “geen gekoppelde player gevonden”).

**Acceptatie:** als er een gekoppeld scherm in Sittard bestaat, ontstaat automatisch een ad-geschikte playlist/mapping en proposal wordt >0 matches.

---

## C) Bonus: “Fix now” knop in waarschuwing (optioneel maar handig)

In de proposal warning UI (waar nu “Koppel locaties…” staat):

* Voeg knop “Nu koppelen” (admin only)
* Call endpoint `POST /api/admin/screens/:screenId/ensure-playlist` (of hergebruik provisioning functie)
* Toon succesmelding en herlaad proposal.

---

## D) Acceptance tests

1. Upload video → open Video Review modal → video speelt af (geen zwart vlak)
2. Proposal preview:

   * Als er een readyForAds screen in Sittard is → krijgt minstens 1 match en toont playlistName
   * Goedkeuren wordt mogelijk
3. Audit logs bevatten `PLAYLIST_AUTO_CREATED` (indien auto-provisioning gebruikt is)

Voer dit uit met minimale wijzigingen en hergebruik bestaande yodeck service/outbox waar mogelijk.

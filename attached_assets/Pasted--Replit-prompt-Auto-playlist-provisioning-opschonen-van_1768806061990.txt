**Replit prompt – Auto-playlist provisioning + opschonen van “foute” bestaande playlists/mappings + proposal opnieuw draaien (end-to-end fix)**

Situatie:

* Video preview werkt.
* Proposal preview geeft “0 van 1 schermen” met melding: “Schermen zonder Yodeck-koppeling of playlist”.
* Scherm is wel gekoppeld, maar er is (nog) geen geldige advertentie-playlist/mapping óf er bestaat al een “foute” playlist/mapping (verkeerde naam/type/koppeling) die het systeem in de war brengt.

Doel:

1. Als er geen geldige ad-playlist bestaat: automatisch aanmaken + koppelen + opslaan in DB.
2. Als er al een “foute” playlist/mapping bestaat: automatisch opschonen (hergebruiken waar mogelijk, anders ontkoppelen/vervangen) zodat proposals altijd matches kunnen vinden.
3. Proposal endpoint moet na provisioning/cleanup automatisch opnieuw simuleren en vervolgens matches tonen.

GEEN grote refactor, hergebruik bestaande Yodeck service/outbox waar kan.

---

## A) Definitie: wat is een “geldige” sellable playlist

Maak helper(s) centraal (bijv. `playlistProvisioningService.ts`):

### A1) Naming convention

Voor elke screen gebruiken we exact één canonical playlist naam:
`{locationName} (auto-playlist-{yodeckPlayerId}-fit)`

### A2) Sellable criteria

Playlist is sellable als:

* bestaat in Yodeck
* gekoppeld aan de juiste player/screen
* in DB mapping gemarkeerd als `playlistType in ['ad','mixed']`
* en niet gemarkeerd als `non_ad`

---

## B) Detecteer “foute” playlists/mappings (cleanup rules)

Voor een gegeven screen (yodeckPlayerId/screenId):

Beschouw als “fout”:

1. DB mapping wijst naar playlistId die niet meer bestaat in Yodeck
2. playlist bestaat wel, maar:

   * naam klopt niet met canonical naam (oude naam / typo)
   * of playlist hangt aan een andere player
   * of playlistType/category is non_ad (of ontbreekt)
3. er zijn meerdere auto-playlists gevonden voor dezelfde player (duplicates)

---

## C) Nieuwe provisioning + cleanup entrypoint

Maak één functie:
`ensureSellablePlaylistForScreen(screenId): Promise<{playlistId, playlistName, actionTaken, warnings}>`

Deze functie doet:

### C1) Load context

* screen uit DB (incl yodeckPlayerId/yodeckUuid/locationId)
* locationName
* haal huidige mapping (als aanwezig)
* haal playlists uit Yodeck (minimaal: id + name + type/category + player assignment als beschikbaar)

### C2) Cleanup (veilig, idempotent)

1. Als mapping playlistId niet bestaat → verwijder mapping
2. Als mapping playlistName niet canonical is:

   * Als playlist in Yodeck bestaat en verder OK is → **rename playlist** naar canonical naam (voorkeur)
   * Als rename niet kan → maak nieuwe canonical playlist en stap over
3. Als playlist aan verkeerde player hangt → ontkoppel mapping en maak/zoek juiste playlist voor deze player
4. Als meerdere playlists matchen op “auto-playlist-{playerId}”:

   * kies de best passende (meest recent / al gekoppeld / canonical naam)
   * markeer de rest als “legacy/disabled” in DB (of ontkoppel) zodat engine ze niet meer gebruikt
   * als mogelijk: hernoem duplicates naar “(legacy)” om verwarring te voorkomen

**Belangrijk:** verwijder geen media hard, alleen mapping/naam/klassificatie aanpassen. Geen destructieve deletes tenzij expliciet veilig.

### C3) Provisioning (als er nog geen geldige bestaat)

* Zoek canonical playlist in Yodeck op naam
* Als niet gevonden:

  * create playlist in Yodeck met canonical naam
  * type: `mixed` of `ad`
* Koppel playlist aan player/screen (zoals jullie mapping-aanpak voorschrijft)
* Schrijf/Upsert DB mapping:

  * screenId
  * yodeckPlaylistId
  * playlistType='ad' (of 'mixed')
  * isAutoGenerated=true
  * lastVerifiedAt=now

### C4) Audit logging

Log audit events:

* `PLAYLIST_AUTO_CREATED`
* `PLAYLIST_MAPPING_FIXED`
* `PLAYLIST_RENAMED`
* `PLAYLIST_MAPPING_REMOVED_STALE`
* `PLAYLIST_DUPLICATES_RESOLVED`

Met metadata: screenId, playerId, playlistId(s), old/new name, reason.

Return `actionTaken` zodat UI kan tonen: “Playlist automatisch aangemaakt/hersteld”.

---

## D) Integreer in proposal endpoint

In `GET /api/admin/assets/:assetId/proposal`:

1. Run proposal simulate normaal
2. Als reason = “geen playlist/mapping” (of matches 0 en oorzaak wijst naar playlist ontbreekt):

   * call `ensureSellablePlaylistForScreen()` voor alle candidate screens in target regio (readyForAds)
   * run proposal simulate opnieuw
3. Return proposal met matches en toon playlistName per match
4. Als na provisioning nog steeds 0 matches: return `noCapacityReason` + nextSteps met echte oorzaak

---

## E) UI polish

In de warning box:

* Toon “We hebben geprobeerd automatisch een playlist te maken/herstellen: <actionTaken>”
* Als het gelukt is: warning verdwijnt en lijst met matches verschijnt.
* Voeg (optioneel) admin knop “Opnieuw proberen” die proposal refetch doet.

---

## F) Acceptatiecriteria (e2e)

1. Er is een gekoppeld screen in Sittard zonder playlist → proposal maakt playlist aan → proposal toont 1 match.
2. Er is een “foute” bestaande playlist (verkeerde naam of stale mapping) → systeem herstelt/renamed/ontkoppelt → proposal toont match.
3. Alles is idempotent: herhaald openen van modal maakt geen duplicates.
4. Audit logs tonen welke fix is uitgevoerd.

Implementeer dit met minimale wijzigingen, hergebruik bestaande yodeck/outbox code, en zorg dat alle wijzigingen veilig zijn (geen destructieve deletes van media).
